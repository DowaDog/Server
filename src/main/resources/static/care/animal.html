<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="https://ryudd.s3.amazonaws.com/dowadog/common/dowadog.png" type="image/x-icon"/>
    <link rel="icon" href="https://ryudd.s3.amazonaws.com/dowadog/common/dowadog.png" type="image/x-icon"/>

    <title>기다릴개 보호소 | 메인페이지</title>

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/font-awesome/css/font-awesome.css" rel="stylesheet">


    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/font-awesome/css/font-awesome.css" rel="stylesheet">
    <link href="/css/animate.css" rel="stylesheet">
    <link href="/css/plugins/jasny/jasny-bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/plugins/sweetalert/sweetalert.css" rel="stylesheet">

</head>

<div id="wrapper">
    <div class="gray-bg" style="min-height: 917px;">
        <div class="row border-bottom">
            <nav class="navbar navbar-static-top white-bg" role="navigation" style="margin-bottom: 0">


                <ul class="nav navbar-top-links navbar-right">

                    <li>
                        <a href="login.html" id="logoutBtn">
                            <i class="fa fa-sign-out"></i> Log out
                        </a>
                    </li>
                </ul>
                <div class="row wrapper border-bottom white-bg page-heading">
                    <div class="col-lg-10">
                        <h2 class="col-xs-offset-1 text-warning"><strong>기다릴개</strong> 보호소 웹 </h2>
                        <ol class="breadcrumb col-xs-offset-1">
                            <li>
                                <a href="/care/main.html">
                                    메인
                                </a>
                            </li>
                            <li>
                                보호 동물 목록
                            </li>
                            <li>
                                <strong>신청서 목록</strong>
                            </li>
                        </ol>
                    </div>
                    <div class="col-lg-2">

                    </div>
                </div>
            </nav>

        </div>


        <div class="wrapper wrapper-content animated fadeInRight">
            <div class="project-list">

                <table class="table table-hover" id="registrationTable">
                    <tbody>
                    <thead>
                    <colgroup>
                        <col width="10%"/>
                        <col width="20%"/>
                        <col width="20%"/>
                        <col width="15%"/>
                        <col width="*"/>
                    </colgroup>
                    <tr>
                        <td>
                        <span class="tooltip-demo text-center">
                        <span class="btn btn-primary" data-toggle="popover" data-placement="auto bottom"
                              data-html="true"
                              data-content=
                                      "<span><strong>deny </strong>입양 반려</span> <br/> 입양 반려 상태를 의미<br/><br/>
                        <span><strong>step0 </strong>입양 신청서 수신 검토 단계 <br/> 신청서 확인 후 상태를 결정합니다</span><br/><br/>
                        <span><strong>step1 </strong>전화 상담 단계</span> <br/>  전화를 통한 상담후 방문 일정을 전송합니다<br><br/>
                        <span><strong>step2 </strong>직접 방문 단계</span> <br/>  사용자의 직접 방문을 확인한 후 작업을 결정합니다<br/><br/>
                        <span><strong>step3 </strong>입양 절차 단계 확인</span> <br/>  각 보호소에서 요구하는 입양 절차가 충족여부에 따른 작업을 결정합니다.<br/> <br/>
                        <span><strong>complete </strong>입양 완료</span> <br/>  입양 완료 상태를 의미합니다<br>"
                        >

                            상태
                        </span>
                        </span>
                        </td>
                        <td>신청자 정보</td>
                        <td>연락처</td>
                        <td>신청서 타입</td>
                        <td class="text-right">작업</td>

                    </tr>
                    </thead>
                    </tbody>


                </table>
            </div>


        </div>

    </div>

</div>

<!--Register VIEW MODAL-->
<div class="modal inmodal" id="regViewModal" tabindex="-1" role="dialog" style="display: none;"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated bounceInRight">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span
                        class="sr-only">Close</span></button>
                <h2 id="regViewModalTitle">신청서
                    <br/>
                    <small class="modal-type"></small>
                </h2>
            </div>

            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-12 b-r">
                        <div class="col-sm-12 row">
                            <div class="form-group col-sm-12">
                                <label class="control-label col-sm-4 text-right"><strong>신청서 타입</strong></label>
                                <span id="regType">online/offline</span>
                            </div>

                            <div class="form-group col-sm-12">
                                <label class="control-label col-sm-4 text-right"><strong>신청자</strong></label>
                                <span id="regUsername">강성찬</span>
                            </div>

                            <div class="form-group col-sm-12">
                                <label class="control-label col-sm-4 text-right"><strong>이메일</strong></label>
                                <span id="regEmail">tjdcks1781@gmail.com</span>
                            </div>

                            <div class="form-group col-sm-12">
                                <label class="control-label col-sm-4 text-right"><strong>주소</strong></label>
                                <span id="regAddress">인천광역시 남구 주안5동 에이스빌 6동 501호</span>
                            </div>

                            <div class="form-group col-sm-12">
                                <label class="control-label col-sm-4 text-right"><strong>직업</strong></label>
                                <span id="regJob">개발자</span>
                            </div>

                            <div class="form-group col-sm-12">
                                <label class="control-label col-sm-4 text-right"><strong>연락처</strong></label>
                                <span id="regPhone">010-2634-0871</span>
                            </div>

                            <div class="form-group col-sm-12">
                                <label class="control-label col-sm-4 text-right"><strong>입양 타입</strong></label>
                                <span id="adoptType">adopt/temp</span>
                            </div>


                            <div class="form-group col-sm-12">
                                <label class="control-label col-sm-4 text-right"><strong>임보 가능기간</strong></label>
                                <span id="tempPeriod">30일</span>
                            </div>

                            <div class="form-group col-sm-12">
                                <label class="control-label col-sm-4 text-right"><strong>반려동물 존재 여부</strong></label>
                                <span id="havePet">있음</span>
                            </div>

                            <div class="form-group col-sm-12">
                                <label class="control-label col-sm-4 text-right"><strong>반려동물 정보</strong></label>
                                <span id="petInfo">귀여움</span>
                            </div>

                            <div class="form-group col-sm-12">
                                <label class="control-label col-sm-4 text-right"><strong>작성일시</strong></label>
                                <span id="createdAt">2019-12-21 11:12:31</span>
                            </div>

                            <div class="form-group col-sm-12">
                                <label class="control-label col-sm-4 text-right"><strong>방문 장소</strong></label>
                                <span id="meetPlace">용인 보호소</span>
                            </div>

                            <div class="form-group col-sm-12">
                                <label class="control-label col-sm-4 text-right"><strong>방문 시간</strong></label>
                                <span id="meetTime">2019년 1월 8일 오후 3시</span>
                            </div>

                            <div class="form-group col-sm-12">
                                <label class="control-label col-sm-4 text-right"><strong>준비물</strong></label>
                                <span id="meetMaterial">1. 개목줄</span>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<!--Regist Step1 MODAL-->
<div class="modal inmodal" id="regModal" tabindex="-1" role="dialog" style="display: none;"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated bounceInRight">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span
                        class="sr-only">Close</span></button>
                <h2 id="regModalTitle">방문 일정
                    <br/>
                    <small class="modal-type"></small>
                </h2>
            </div>

            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-12 b-r">
                        <form id="meetForm">
                            <div class="col-sm-12 row">
                                <div class="form-group col-sm-12">
                                    <label class="control-label text-right"><strong>장소</strong></label>
                                    <input type="text" class="form-control modalInput" name="place" placeholder="용인 보호소"
                                           required>
                                </div>

                                <div class="form-group col-sm-12">
                                    <label class="control-label text-right"><strong>일시</strong></label>
                                    <input type="email" class="form-control modalInput" name="time"
                                           placeholder="12월 25 (화) 오후 5시" required>
                                </div>

                                <div class="form-group col-sm-12">
                                    <label class="control-label text-right"><strong>준비물</strong></label>
                                    <textarea name="material" rows="8" style="width:100%"
                                              placeholder="1. 강아지목줄 &#13;&#10;2. 신분증사본 &#13;&#10;3. 강아지 집"></textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" id="modalStep1AcceptBtn">승인</button>
            </div>

        </div>
    </div>
</div>

</div>

<!-- Mainly scripts -->
<script src="/js/jquery-3.1.1.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/plugins/metisMenu/jquery.metisMenu.js"></script>
<script src="/js/plugins/slimscroll/jquery.slimscroll.min.js"></script>

<!-- Custom and plugin javascript -->
<script src="/js/inspinia.js"></script>
<script src="/js/plugins/pace/pace.min.js"></script>

<!-- Jasny -->
<script src="/js/plugins/jasny/jasny-bootstrap.min.js"></script>

<!-- CodeMirror -->
<script src="/js/plugins/sweetalert/sweetalert.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>

<script src="./js/logincheck.js"></script>


<script>
    $('#logoutBtn').click(function () {
        var cookies = $.cookie();
        for (var cookie in cookies) {
            $.removeCookie(cookie);
        }
    });

    var urlParams = new URLSearchParams(window.location.search);
    var animalId = urlParams.get('animalId');

    var init = (function () {

        var headers = {};
        headers["Authorization"] = $.cookie("accessToken");

        var dataObj;
        var modalTargetObj;

        $.ajax({
            url: "/api/care/animals/" + animalId,
            type: 'GET',
            headers: headers,
            success: function (res) {
                dataObj = res;

                for (var i = 0; i < res.length; i++) {
                    makeAnimalContentsHtml(res[i]);
                }

                var tableRegStatus = $('#registrationTable').find('.regStatus');

                for (var i = 0; i < tableRegStatus.length; i++) {
                    $rowReg = $(tableRegStatus[i]);

                    if ($rowReg.text() === "deny") {
                        $rowReg.closest('tr').find('.actionBtn').children().remove();
                    }

                    if ($rowReg.text() === "complete") {
                        $rowReg.closest('tr').find('.completeAcceptBtn').remove();
                        $rowReg.closest('tr').find('.completeDenyBtn').remove();
                    }

                    if ($rowReg.text() === "step1") {
                        $rowReg.closest('tr').find('.step1AcceptBtn').attr("data-toggle", "modal");
                        $rowReg.closest('tr').find('.step1AcceptBtn').attr("data-target", "#regModal");
                    }


                }


                $('.viewBtn').click(function () {
                    var regId = $(this).closest('.regRow').attr('data');

                    for (var i = 0; i < dataObj.length; i++) {
                        if (dataObj[i].id == regId) {
                            modalTargetObj = dataObj[i];
                        }
                    }

                    $('#regType').text((modalTargetObj.regType === "online") ? "온라인" : "오프라인");
                    $('#regUsername').text(modalTargetObj.user.decodedName);
                    $('#regEmail').text(modalTargetObj.email);
                    $('#regAddress').text(modalTargetObj.address);
                    $('#regJob').text(modalTargetObj.job);
                    $('#regPhone').text(modalTargetObj.phone);
                    $('#adoptType').text((modalTargetObj.adoptType === "adopt") ? "입양" : "임시보호");

                    $('#tempPeriod').text(modalTargetObj.tempPeriod);
                    $('#havePet').text(modalTargetObj.havePet);
                    $('#petInfo').text(modalTargetObj.petInfo);
                    $('#createdAt').text(modalTargetObj.createdAt.split("T")[0]);
                    $('#meetPlace').text(modalTargetObj.meetPlace);
                    $('#meetTime').text(modalTargetObj.meetTime);
                    $('#meetMaterial').text(modalTargetObj.meetMaterial);


                    //adoptType
                    //regType


                    $(this).attr("data-toggle", "modal");
                    $(this).attr("data-target", "#regViewModal");
                })


                $('.step0AcceptBtn').click(function () {
                    var regId = $(this).closest('.regRow').attr('data');

                    $.ajax({
                        url: "/api/care/registrations/" + regId + "/acceptStepZero",
                        type: 'PUT',
                        headers: headers,
                        success: function (res) {
                            if (res.status === 400) {
                                alert("올바르지 않은 요청입니다");
                            } else {
                                alert("스텝 변경 성공");
                            }
                            window.location.reload();
                        },
                        error: function (res) {
                            alert("서버 에러");
                        }
                    });
                });

                $('.step0DenyBtn').click(function () {
                    var regId = $(this).closest('.regRow').attr('data');

                    $.ajax({
                        url: "/api/care/registrations/" + regId + "/denyStepZero",
                        type: 'PUT',
                        headers: headers,
                        success: function (res) {
                            if (res.status === 400) {
                                alert("올바르지 않은 요청입니다");
                            } else {
                                alert("스텝 변경 성공");
                            }
                            window.location.reload();

                        },
                        error: function (res) {
                            alert("서버 에러");
                        }
                    });
                });


                //step1 절차
                $('#modalStep1AcceptBtn').click(function (e) {
                    e.preventDefault();

                    var regId = $('.step1AcceptBtn').closest('.regRow').attr('data');

                    var meetForm = {
                        meetPlace: $('input[name=place]').val(),
                        meetTime: $('input[name=time]').val(),
                        meetMaterial: $('textarea[name=material]').val()
                    }



                    $.ajax({
                        type: "PUT",
                        headers: headers,
                        contentType: "application/json",
                        url: "/api/care/registrations/" + regId + "/acceptStepOne",
                        data: JSON.stringify(meetForm),
                        timeout: 600000,
                        success: function (res) {
                            if (res.status === 400) {
                                alert("올바르지 않은 요청입니다");
                            } else {
                                alert("스텝 변경 성공");
                                window.location.reload();
                            }

                        },
                        error: function () {
                            alert("올바르지 않은 요청입니다");
                        }
                    });

                });


                $('.step1DenyBtn').click(function () {
                    var regId = $(this).closest('.regRow').attr('data');

                    $.ajax({
                        url: "/api/care/registrations/" + regId + "/denyStepOne",
                        type: 'PUT',
                        headers: headers,
                        success: function (res) {
                            if (res.status === 400) {
                                alert("올바르지 않은 요청입니다");
                            } else {
                                alert("스텝 변경 성공");
                                window.location.reload();
                            }

                        },
                        error: function (res) {
                            alert("서버 에러");
                        }
                    });
                });

                $('.step2AcceptBtn').click(function () {
                    var regId = $(this).closest('.regRow').attr('data');

                    $.ajax({
                        url: "/api/care/registrations/" + regId + "/acceptStepTwo",
                        type: 'PUT',
                        headers: headers,
                        success: function (res) {
                            if (res.status === 400) {
                                alert("올바르지 않은 요청입니다");
                            } else {
                                alert("스텝 변경 성공");
                            }
                            window.location.reload();

                        },
                        error: function (res) {
                            alert("서버 에러");
                        }
                    });
                });

                $('.step2DenyBtn').click(function () {
                    var regId = $(this).closest('.regRow').attr('data');

                    $.ajax({
                        url: "/api/care/registrations/" + regId + "/denyStepTwo",
                        type: 'PUT',
                        headers: headers,
                        success: function (res) {
                            if (res.status === 400) {
                                alert("올바르지 않은 요청입니다");
                            } else {
                                alert("스텝 변경 성공");
                            }
                            window.location.reload();

                        },
                        error: function (res) {
                            alert("서버 에러");
                        }
                    });
                });

                $('.step3AcceptBtn').click(function () {
                    var regId = $(this).closest('.regRow').attr('data');

                    $.ajax({
                        url: "/api/care/registrations/" + regId + "/acceptFinal",
                        type: 'PUT',
                        headers: headers,
                        success: function (res) {
                            if (res.status === 400) {
                                alert("올바르지 않은 요청입니다");
                            } else {
                                alert("스텝 변경 성공");
                            }
                            window.location.reload();

                        },
                        error: function (res) {
                            alert("서버 에러");
                        }
                    });
                });

                $('.step3DenyBtn').click(function () {
                    var regId = $(this).closest('.regRow').attr('data');

                    $.ajax({
                        url: "/api/care/registrations/" + regId + "/denyFinal",
                        type: 'PUT',
                        headers: headers,
                        success: function (res) {
                            if (res.status === 400) {
                                alert("올바르지 않은 요청입니다");
                            } else {
                                alert("스텝 변경 성공");
                            }
                            window.location.reload();

                        },
                        error: function (res) {
                            alert("서버 에러");
                        }
                    });
                });

            },
            error: function (e) {
                swal({
                    title: "UNAUTHORIZATION",
                    text: "인증정보가 만료되었습니다. 자동로그인을 시도합니다.",
                    type: "error"
                }, function () {
                    doRefreshRequest();
                    // location.href = "./login.html"
                });
            }
        });

        var makeAnimalContentsHtml = function (res) {

            var id = res.id;
            var regStatus = res.regStatus;
            var userName = res.user.decodedName;
            var updatedAt = res.updatedAt;
            var phone = res.user.decodedPhone;
            var regType = res.regType;

            var registrationHtml =
                " <tr class='regRow' data='" + res.id + "'>\n" +
                "            <td class=\"project-status\">\n" +
                "                <span class=\"label regStatus\">" + regStatus + "</span>\n" +
                "                </td>\n" +
                "                <td class=\"project-title\">\n" +
                "                신청자 명 : " + userName +
                "            <br>\n" +
                "            <small><strong>Updated at</strong> " + updatedAt.split("T")[0] + "   " + updatedAt.split("T")[1] + "</small>\n" +
                "            </td>" +
                "            <n></n><" +
                "               <td class=\"project-title\">" + phone +
                "               </td>" +
                "               <td class=\"project-title\">" + regType +
                "               </td>" +
                "            <td class=\"project-actions actionBtn\">\n" +
                "                <span class=\"btn btn-white btn-sm viewBtn\"><i class=\"fa fa-folder\"></i> 열람 </span>\n" +
                "            <span class=\"btn btn-primary btn-sm " + regStatus + "AcceptBtn\"><i class=\"fa fa-pencil\"></i> 수락 </span>\n" +
                "            <span class=\"btn btn-danger btn-sm " + regStatus + "DenyBtn\"><i class=\"fa fa-pencil\"></i> 거절 </span>\n" +
                "            </td>\n" +
                "            </tr>";
            $('#registrationTable').append(registrationHtml);
        }
    })();


</script>

<style>
    a {
        color: inherit;
    }

</style>

